---
# tasks file for ansible_role_build_images

 - name: container_name
   ansible.builtin.debug:
      msg: "{{container_name}} {{base_container_image}}"

 - name: Check if the base container already exists
   ansible.builtin.command: "podman container exists {{ container_name }}"
   register: base_container_exists
   ignore_errors: yes


# - name: Run a task if the command returns zero exit status
#   debug:
#     msg: "The command was successful (exit status 0)"
#   when: base_container_exists.rc == 0
#
# - name: Run a different task if the command returns a non-zero exit status
#   debug:
#     msg: "The command was not successful (exit status {{ command_result.rc }})"
#   when: base_container_exists.rc != 0

# This is done in a separate step to allow for auth_file
 - name: Pull the base container image
   containers.podman.podman_image:
      name: "{{base_container_image}}"
      auth_file: "{{ registry_auth_file }}"
   register: base_container_image_information

 - name: Print base_container_image_information
   ansible.builtin.debug:
      msg: "{{base_container_image_information['image'][0]['Id']}}"

 - name: Make sure there is no base container yet
   containers.podman.podman_container:
      name: "{{container_name}}"
      state: absent
   when: '"remove_base_container" and base_container_exists.rc == 0'


 - name: Create and start the base container (recreate=yes)
   containers.podman.podman_container:
      name:  "{{container_name}}"
      #image: "{{base_container_image}}"
      image: "{{base_container_image_information['image'][0]['Id']}}" # use this to force using the local image and not pulling without auth_file
      state: "started"
      remove: yes
      entrypoint: "/usr/sbin/init"
      #init: yes
      recreate: yes
   when: base_container_exists.rc != 0

 - name: Start the base container
   containers.podman.podman_container:
      name:  "{{container_name}}"
      #image: "{{base_container_image}}"
      image: "{{base_container_image_information['image'][0]['Id']}}" # use this to force using the local image and not pulling without auth_file
      state: "started"
      remove: yes
      entrypoint: "/usr/sbin/init"
   when: base_container_exists.rc == 0
